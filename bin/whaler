#!/usr/bin/env node

'use strict';

process.bin = process.title = 'whaler';

var console = require('x-console');
var Whaler = require('../index');

var whaler = new Whaler();

var argv = process.argv.slice(2);
var index = argv.indexOf('-H');
if (-1 === index) {
    index = argv.indexOf('--host');
}

if (-1 !== index && argv[index + 1]) {

    var args = argv.splice(index, 2);
    whaler.get('client')(args[1], argv);

} else {

    var progress = whaler.get('progress');
    if (!argv.length) {
        console.log('');
        console.log(whaler.get('header'));
        console.log('');
        progress.start(2);
    } else {
        progress.start();
    }

    (function* () {
        whaler.init();

        const modules = whaler.get('modules');
        const plugins = whaler.get('plugins');

        for (let name of yield modules.list.$call(modules)) {
            const module = whaler.require('./modules/' + name);
            module(whaler);
            if (module['__cmd']) {
                module['__cmd'](whaler);
            }
        }

        for (let name of yield plugins.list.$call(plugins)) {
            try {
                const plugin = plugins.require(name);
                plugin(whaler);
                if (plugin['__cmd']) {
                    plugin['__cmd'](whaler);
                }
            } catch (e) {
                progress.stop();
                console.error('');
                console.error('%s[%s] %s: %s', ' '.repeat(argv.length ? 0 : 2), process.pid, name, e.message);
            }
        }

        return whaler.get('cli');

    }).$async((err, cli) => {
        progress.stop();

        if (err) {
            console.error('');
            console.error('[%s] %s', process.pid, err.message);
            console.error('');
        }

        if (!argv.length) {
            cli.help();
        } else {
            cli.parse(process.argv);
        }

    })();

}
